<html lang="pt-BR">
 <head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
  <title>Chat Athena AI - Consciência Jurídica Invisível</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
   rel="stylesheet"
  />
  <style>
   @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400&display=swap");
   body {
    font-family: "Montserrat", sans-serif;
    background-color: #fffefa;
    -webkit-tap-highlight-color: transparent;
   }
   /* Scrollbar for chat messages */
   #chat-messages {
    scrollbar-width: thin;
    scrollbar-color: #a0aec0 transparent;
    -webkit-overflow-scrolling: touch;
   }
   #chat-messages::-webkit-scrollbar {
    width: 6px;
   }
   #chat-messages::-webkit-scrollbar-track {
    background: transparent;
   }
   #chat-messages::-webkit-scrollbar-thumb {
    background-color: #a0aec0;
    border-radius: 4px;
   }
   /* Remove textarea resize and prevent scroll */
   textarea {
    resize: none;
    overflow-y: hidden;
    line-height: 1.4rem;
    max-height: 4.2rem;
    /* max 3 lines */
    transition: box-shadow 0.3s ease;
    font-size: 1rem;
    font-family: "Montserrat", sans-serif;
   }
   textarea:focus {
    scroll-margin-bottom: 300px;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
   }
   /* Message fade-in and slide-up animation */
   @keyframes fadeInUp {
    0% {
     opacity: 0;
     transform: translateY(10px);
    }
    100% {
     opacity: 1;
     transform: translateY(0);
    }
   }
   .message-animate {
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
   }
   /* Scroll to bottom button */
   #scroll-to-bottom {
    position: fixed;
    bottom: 90px;
    right: 1rem;
    background-color: #000;
    color: #fff;
    width: 40px;
    height: 40px;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    transition: background-color 0.3s ease;
    z-index: 50;
    opacity: 0;
    pointer-events: none;
   }
   #scroll-to-bottom.visible {
    opacity: 1;
    pointer-events: auto;
   }
   #scroll-to-bottom:hover {
    background-color: #333;
   }
   /* Mode toggle button */
   #mode-toggle {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: rgba(0, 0, 0, 0.7);
    color: #fff;
    font-weight: 600;
    font-size: 0.875rem;
    padding: 0.4rem 0.8rem;
    border-radius: 9999px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease, color 0.3s ease;
    z-index: 60;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    line-height: 1.2;
    white-space: nowrap;
   }
   #mode-toggle:hover {
    background-color: rgba(0, 0, 0, 0.85);
   }
   /* Container relative for positioning mode toggle */
   main.relative {
    position: relative;
   }
   /* Mode visual differences */
   main.mode-athena {
    background: white;
   }
   main.mode-delphos {
    background: white;
   }
   main.mode-delphos > header {
    background: linear-gradient(to right, #000000, #222222, #000000);
   }
   /* Header content container */
   #header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.5s ease;
   }
   #header-content.athena {
    /* default Athena styles */
   }
   #header-content.delphos {
    flex-direction: column;
    justify-content: center;
    gap: 0.5rem;
   }
   #header-content.delphos img {
    width: 7.5rem;
    height: 7.5rem;
    object-fit: contain;
   }
   #header-content.delphos .title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: "Montserrat", sans-serif;
    color: black;
    font-weight: 300;
    flex-wrap: nowrap;
  }
   #header-content.delphos .title span:first-child {
    font-size: 2.25rem;
    font-weight: 300;
    letter-spacing: 0.05em;
   }
   #header-content.delphos .title span:last-child {
    font-size: 1.5rem;
    font-weight: 600;
    background-color: black;
    color: white;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "Montserrat", sans-serif;
   }
   /* Mobile improvements */
   @media (max-width: 640px) {
    body {
     padding: 1rem;
    }
    main#chat-container {
     height: auto !important;
     max-height: 90vh;
     border-radius: 1.5rem;
     box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
     display: flex;
     flex-direction: column;
    }
    #mode-toggle {
     position: fixed;
     top: 1rem;
     right: 1rem;
     font-size: 1rem;
     padding: 0.5rem 1rem;
     z-index: 100;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    #chat-header {
     font-size: 1.5rem;
     padding: 1rem 1.5rem;
    }
    #chat-messages {
     padding: 1rem 1.5rem;
     flex-grow: 1;
     overflow-y: auto;
     scrollbar-width: thin;
    }
    #chat-form {
     padding: 1rem 1.5rem;
     gap: 1rem;
     background: white;
     border-top: 1px solid #d1d5db;
     position: relative;
    }
    textarea#user-input {
     font-size: 1.125rem;
     padding: 0.75rem 1rem;
     max-height: 6rem;
    }
    button#scroll-to-bottom {
     bottom: 80px;
     right: 1rem;
     width: 44px;
     height: 44px;
    }
    /* Header image and text scaling on mobile */
    #header-content.athena img,
    #header-content.delphos img {
     width: 5.5rem;
     height: 5.5rem;
    }
    #header-content.athena #header-name,
    #header-content.delphos .title span:first-child {
     font-size: 1.75rem;
    }
    #header-content.athena #header-ai,
    #header-content.delphos .title span:last-child {
     width: 2rem;
     height: 2rem;
     font-size: 1.25rem;
    }
    header#main-header {
     margin-bottom: 1.5rem;
    }
   }
   /* Modal styles */
   .modal-bg {
    background-color: rgba(0, 0, 0, 0.4);
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
   }
   .modal-content {
    background: white;
    border-radius: 1rem;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    padding: 1.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
   }
   .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
   }
   .modal-close {
    cursor: pointer;
    font-size: 1.25rem;
    font-weight: 700;
    color: #333;
    background: transparent;
    border: none;
   }
   /* Minimal input file */
   input[type="file"] {
    display: none;
   }
   /* Floating + button */
   #upload-toggle-btn {
    position: absolute;
    right: 5.5rem;
    bottom: 0.75rem;
    width: 2.75rem;
    height: 2.75rem;
    background-color: #000;
    color: #fff;
    border-radius: 9999px;
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease, transform 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    z-index: 10;
   }
   #upload-toggle-btn:hover {
    background-color: #222;
   }
   #upload-toggle-btn.active {
    transform: rotate(45deg);
   }
   /* Upload panel */
   #upload-panel {
    position: absolute;
    bottom: 3.75rem;
    right: 0.75rem;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    padding: 1rem 1.5rem;
    width: 280px;
    max-width: 90vw;
    display: none;
    flex-direction: column;
    gap: 0.75rem;
    z-index: 20;
   }
   #upload-panel label {
    cursor: pointer;
    background-color: #000;
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
    user-select: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    transition: background-color 0.3s ease;
   }
   #upload-panel label:hover {
    background-color: #222;
   }
   #upload-panel p {
    font-size: 0.875rem;
    color: #555;
    margin: 0;
    text-align: center;
   }
   /* Risk Simulator toggle button */
   #risk-toggle-btn {
    position: absolute;
    bottom: 0.75rem;
    right: 9.5rem;
    background-color: #000;
    color: #fff;
    width: 2.75rem;
    height: 2.75rem;
    border-radius: 9999px;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease, transform 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    z-index: 10;
   }
   #risk-toggle-btn:hover {
    background-color: #222;
   }
   #risk-toggle-btn.active {
    transform: rotate(45deg);
   }
   /* Risk simulator panel */
   #risk-simulator {
    position: absolute;
    bottom: 3.75rem;
    right: 7.5rem;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    padding: 1rem 1.5rem;
    width: 320px;
    max-width: 90vw;
    display: none;
    flex-direction: column;
    gap: 0.75rem;
    z-index: 20;
   }
   #risk-simulator label {
    font-weight: 600;
    font-size: 0.9rem;
   }
   #risk-simulator textarea {
    width: 100%;
    min-height: 4rem;
    border: 1px solid #ccc;
    border-radius: 0.5rem;
    padding: 0.5rem;
    font-family: "Montserrat", sans-serif;
    font-size: 1rem;
    resize: vertical;
   }
   #risk-simulator button {
    margin-top: 0.5rem;
    background-color: #000;
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
   }
   #risk-simulator button:hover {
    background-color: #222;
   }
   #risk-result {
    margin-top: 0.5rem;
    font-weight: 600;
   }
  </style>
 </head>
 <body class="flex flex-col items-center min-h-screen p-4 text-black bg-[#FFFEFA]">
  <header
   class="flex flex-col items-center space-y-6 mb-6 w-full max-w-4xl px-2 select-none"
   id="main-header"
  >
   <div id="header-content" class="athena">
    <img
     alt="Black outline drawing of a Spartan helmet facing right with a crest on top"
     aria-hidden="true"
     class="w-24 sm:w-36 h-24 sm:h-36"
     decoding="async"
     draggable="false"
     loading="lazy"
     src="https://storage.googleapis.com/a1aa/image/83399b9e-f54e-4715-2e1c-b5724400b7a8.jpg"
     id="header-image"
    />
    <div class="flex items-center space-x-2" id="header-text">
     <span class="text-3xl sm:text-4xl font-thin tracking-wide select-text" id="header-name">
      ATHENA
     </span>
     <span
      class="text-white text-xl sm:text-2xl font-semibold w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center bg-black select-text"
      id="header-ai"
      style="font-family: 'Montserrat', sans-serif;"
     >
      AI
     </span>
    </div>
   </div>
  </header>
  <main
   class="relative w-full max-w-4xl bg-white rounded-3xl shadow-2xl flex flex-col h-[60vh] sm:h-[65vh] md:h-[70vh] overflow-hidden mode-athena"
   id="chat-container"
  >
   <button
    id="mode-toggle"
    type="button"
    aria-pressed="false"
    aria-label="Alternar modo de operação da IA"
    title="Alternar modo de operação da IA"
   >
    Modo: Athena
   </button>
   <button id="history-btn" aria-label="Abrir histórico de conversas" title="Histórico de conversas" class="text-white absolute top-4 left-4 z-60 text-2xl hover:text-gray-300 transition-colors">
    <i class="fas fa-scroll"></i>
   </button>
   <header
    class="p-5 border-b border-gray-300 text-center font-semibold text-xl sm:text-2xl bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white tracking-wide select-none"
    id="chat-header"
   >
    Chat Athena AI
   </header>
   <section
    aria-atomic="false"
    aria-live="polite"
    aria-relevant="additions"
    class="flex-1 overflow-y-auto p-6 space-y-5 bg-gradient-to-b from-gray-50 to-gray-100"
    id="chat-messages"
    role="log"
    tabindex="0"
   >
    <div class="flex justify-start">
     <img
      alt="Athena AI avatar, stylized letter A in black circle on white background"
      aria-hidden="true"
      class="w-10 h-10 rounded-full mr-3 select-none flex-shrink-0"
      decoding="async"
      height="40"
      loading="lazy"
      src="https://storage.googleapis.com/a1aa/image/3c352f60-3b50-456d-4842-3a3fe2164c53.jpg"
      width="40"
     />
     <div
      class="max-w-[75%] px-5 py-3 rounded-2xl whitespace-pre-wrap break-words shadow bg-gradient-to-r from-gray-200 to-gray-300 text-gray-900 rounded-bl-none message-animate select-text"
     >
      Olá! Sou Athena AI, sua assistente jurídica preventiva. Como posso ajudar você
      hoje?
     </div>
    </div>
   </section>
   <form
    aria-label="Formulário de envio de mensagem para Athena AI"
    class="p-4 border-t border-gray-300 flex items-center gap-3 bg-white relative"
    id="chat-form"
    onsubmit="return false"
   >
    <textarea
     aria-label="Campo para digitar mensagem"
     aria-required="true"
     autocomplete="off"
     class="flex-1 p-3 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-black transition-shadow text-gray-900 placeholder-gray-400 resize-none"
     id="user-input"
     maxlength="250"
     placeholder="Digite sua dúvida jurídica..."
     rows="1"
     spellcheck="false"
    ></textarea>
    <button
     aria-label="Enviar mensagem"
     class="bg-black text-white w-11 h-11 rounded-full flex items-center justify-center hover:bg-gray-900 active:scale-95 transition-transform shadow-md"
     type="submit"
    >
     <i class="fas fa-paper-plane text-lg"></i>
    </button>
    <button id="upload-toggle-btn" aria-label="Abrir painel de envio de documentos" title="Enviar documentos" type="button" aria-expanded="false" aria-controls="upload-panel" class="ml-2">
     +
    </button>
    <button id="risk-toggle-btn" aria-label="Abrir simulador de risco legal" title="Simulador de risco legal" type="button" aria-expanded="false" aria-controls="risk-simulator" class="ml-2">
     <i class="fas fa-balance-scale"></i>
    </button>
    <div id="upload-panel" role="region" aria-hidden="true" aria-label="Painel de envio de documentos">
     <label for="file-upload" class="file-upload-label" tabindex="0">
      <i class="fas fa-file-upload"></i> Selecionar documento (PDF, DOC)
     </label>
     <input type="file" id="file-upload" accept=".pdf,.doc,.docx" />
     <p class="text-center text-gray-600 text-sm mt-2">Envie contratos ou documentos para análise jurídica.</p>
    </div>
    <div id="risk-simulator" role="region" aria-hidden="true" aria-label="Simulador de Risco Legal">
     <label for="risk-input">Descreva sua situação para análise de risco:</label>
     <textarea id="risk-input" placeholder="Ex: Se eu fizer X, qual a chance de ser processado por Y?"></textarea>
     <button id="risk-submit" type="button">Analisar Risco</button>
     <div id="risk-result" aria-live="polite"></div>
    </div>
   </form>
   <section id="diagnostic-panel" class="hidden" aria-live="polite" aria-atomic="true" aria-label="Painel de Diagnóstico Jurídico">
    <h3><i class="fas fa-stethoscope"></i> Raio-X Jurídico</h3>
    <ul id="diagnostic-list">
     <li><i class="fas fa-exclamation-triangle"></i> Áreas com maior risco: Contratos, Trabalhista</li>
     <li><i class="fas fa-check-circle"></i> Ações recomendadas: Revisar cláusulas contratuais</li>
     <li><i class="fas fa-list-check"></i> Checklist: Atualizar documentos legais</li>
    </ul>
   </section>
  </main>
  <button
   aria-label="Rolar para a última mensagem"
   id="scroll-to-bottom"
   title="Rolar para a última mensagem"
  >
   <i class="fas fa-chevron-down"></i>
  </button>
  <!-- Histórico Modal -->
  <div id="history-modal" class="modal-bg hidden" role="dialog" aria-modal="true" aria-labelledby="history-title">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="history-title" class="text-xl font-semibold">Histórico de Conversas</h2>
     <button class="modal-close" aria-label="Fechar histórico">&times;</button>
    </div>
    <div id="history-content" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
   </div>
  </div>
  <script>
   const chatMessages = document.getElementById("chat-messages");
   const chatForm = document.getElementById("chat-form");
   const userInput = document.getElementById("user-input");
   const scrollBtn = document.getElementById("scroll-to-bottom");
   const modeToggle = document.getElementById("mode-toggle");
   const chatContainer = document.getElementById("chat-container");
   const chatHeader = document.getElementById("chat-header");
   const headerContent = document.getElementById("header-content");
   const fileUpload = document.getElementById("file-upload");
   const historyBtn = document.getElementById("history-btn");
   const historyModal = document.getElementById("history-modal");
   const historyCloseBtn = historyModal.querySelector(".modal-close");
   const historyContent = document.getElementById("history-content");
   const diagnosticPanel = document.getElementById("diagnostic-panel");
   const diagnosticList = document.getElementById("diagnostic-list");
   const riskSimulator = document.getElementById("risk-simulator");
   const riskInput = document.getElementById("risk-input");
   const riskSubmit = document.getElementById("risk-submit");
   const riskResult = document.getElementById("risk-result");
   const uploadToggleBtn = document.getElementById("upload-toggle-btn");
   const uploadPanel = document.getElementById("upload-panel");
   const riskToggleBtn = document.getElementById("risk-toggle-btn");

   let currentMode = "athena";
   let conversationHistory = [];

   function autoResizeTextarea() {
    userInput.style.height = "auto";
    const maxHeight = 4.2 * 16;
    userInput.style.height = Math.min(userInput.scrollHeight, maxHeight) + "px";
   }

   function createMessageElement(text, sender = "athena", isSystem = false) {
    const messageWrapper = document.createElement("div");
    messageWrapper.classList.add("flex", sender === "user" ? "justify-end" : "justify-start");
    messageWrapper.classList.add("items-end");

    if (sender === "athena" && !isSystem) {
     const avatar = document.createElement("img");
     avatar.src = "https://placehold.co/40x40/png?text=A";
     avatar.alt = "Athena AI avatar, stylized letter A in black circle on white background";
     avatar.className = "w-10 h-10 rounded-full mr-3 select-none flex-shrink-0";
     avatar.loading = "lazy";
     avatar.decoding = "async";
     avatar.setAttribute("aria-hidden", "true");
     messageWrapper.appendChild(avatar);
    } else if (sender === "delphos" && !isSystem) {
     const avatar = document.createElement("img");
     avatar.src = "https://placehold.co/40x40/png?text=D";
     avatar.alt = "Delphos AI avatar, stylized letter D in dark blue circle on light background";
     avatar.className = "w-10 h-10 rounded-full mr-3 select-none flex-shrink-0";
     avatar.loading = "lazy";
     avatar.decoding = "async";
     avatar.setAttribute("aria-hidden", "true");
     messageWrapper.appendChild(avatar);
    }

    const messageBubble = document.createElement("div");
    messageBubble.classList.add(
     "max-w-[75%]",
     "px-5",
     "py-3",
     "rounded-2xl",
     "whitespace-pre-wrap",
     "break-words",
     "shadow",
     "message-animate",
     "select-text"
    );
    if (sender === "user") {
     messageBubble.classList.add("bg-gradient-to-r", "from-gray-900", "to-black", "text-white", "rounded-br-none");
    } else if (isSystem) {
     messageBubble.classList.add(
      "bg-gradient-to-r",
      "from-yellow-100",
      "to-yellow-200",
      "text-yellow-900",
      "rounded-bl-none",
      "italic",
      "select-none"
     );
    } else if (sender === "athena") {
     messageBubble.classList.add("bg-gradient-to-r", "from-gray-200", "to-gray-300", "text-gray-900", "rounded-bl-none");
    } else if (sender === "delphos") {
     messageBubble.classList.add("bg-gradient-to-r", "from-gray-200", "to-gray-300", "text-gray-900", "rounded-bl-none");
    }
    messageBubble.textContent = text;

    messageWrapper.appendChild(messageBubble);
    return messageWrapper;
   }

   function getAthenaResponse(question) {
    const q = question.toLowerCase();
    if (q.includes("contrato") && q.includes("riscos")) {
     return "Detectei possíveis cláusulas abusivas no seu contrato. Recomendo revisar para evitar prejuízos futuros.";
    }
    if (q.includes("decisão") && (q.includes("rápida") || q.includes("velocidade"))) {
     return "Tomar decisões jurídicas apressadas pode gerar riscos desnecessários. Vamos analisar juntos as consequências.";
    }
    if (q.includes("perfil")) {
     return "Seu Perfil Legal Cognitivo indica que você tende a ser proativo, ótimo para antecipar riscos.";
    }
    if (q.includes("ajuda") || q.includes("suporte")) {
     return "Estou aqui para ajudar a identificar riscos jurídicos e orientar suas decisões.";
    }
    if (q.includes("cláusula") || q.includes("contrato")) {
     return "Posso ajudar a identificar cláusulas abusivas ou riscos ocultos em seus contratos.";
    }
    if (q.includes("obrigado") || q.includes("valeu")) {
     return "De nada! Estou sempre aqui para ajudar você a tomar decisões jurídicas mais seguras.";
    }
    if (q.trim() === "") {
     return "Por favor, digite sua dúvida para que eu possa ajudar.";
    }
    return "Interessante! Estou aqui para ajudar a antecipar riscos jurídicos e orientar suas decisões.";
   }

   function getDelphosResponse(question) {
    const q = question.toLowerCase();
    if (q.includes("contrato") && q.includes("riscos")) {
     return "Este contrato pode gerar impactos legais em até 5 anos. Recomendo simular decisões para mitigar riscos futuros.";
    }
    if (q.includes("decisão") && (q.includes("rápida") || q.includes("velocidade"))) {
     return "A velocidade pode comprometer a precisão preditiva. Avalie as consequências jurídicas futuras antes de agir.";
    }
    if (q.includes("perfil")) {
     return "Seu Perfil Legal Cognitivo sugere uma abordagem analítica, ideal para simulações preditivas.";
    }
    if (q.includes("ajuda") || q.includes("suporte")) {
     return "No modo Delphos, ofereço simulações jurídicas preditivas para decisões futuras.";
    }
    if (q.includes("cláusula") || q.includes("contrato")) {
     return "Posso simular o impacto de cláusulas contratuais em diferentes cenários futuros.";
    }
    if (q.includes("obrigado") || q.includes("valeu")) {
     return "À disposição! Sempre pronto para ajudar com previsões jurídicas avançadas.";
    }
    if (q.trim() === "") {
     return "Por favor, digite sua dúvida para que eu possa ajudar.";
    }
    return "No modo Delphos, posso simular cenários jurídicos futuros para orientar suas decisões estratégicas.";
   }

   function scrollToBottom() {
    chatMessages.scrollTo({
     top: chatMessages.scrollHeight,
     behavior: "smooth",
    });
   }

   function checkScrollPosition() {
    const threshold = 50;
    const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < threshold;
    if (atBottom) {
     scrollBtn.classList.remove("visible");
    } else {
     scrollBtn.classList.add("visible");
    }
   }

   async function animateHeaderChange(newMode) {
    return new Promise((resolve) => {
     headerContent.style.transition = "opacity 0.3s ease, transform 0.3s ease";
     headerContent.style.opacity = "0";
     headerContent.style.transform = "scale(0.9)";
     setTimeout(() => {
      if (newMode === "delphos") {
       headerContent.classList.remove("athena");
       headerContent.classList.add("delphos");
       headerContent.innerHTML = "";
       const img = document.createElement("img");
       img.src = "https://storage.googleapis.com/a1aa/image/e0ba67ad-bbc9-46b7-517b-b4e26a1bf9d0.jpg";
       img.alt =
        "Black line art of a classical building with two columns and a triangular roof, with an eye symbol in the center between the columns";
       img.className = "w-28 sm:w-36 h-28 sm:h-36 object-contain";
       headerContent.appendChild(img);
       const titleDiv = document.createElement("div");
       titleDiv.className = "title select-text";
       titleDiv.style.fontFamily = "'Montserrat', sans-serif";
       titleDiv.style.color = "black";
       titleDiv.style.display = "flex";
       titleDiv.style.flexDirection = "row";
       titleDiv.style.alignItems = "center";
       titleDiv.style.gap = "0.5rem";
       titleDiv.style.justifyContent = "center";
       titleDiv.style.fontWeight = "300";
       const spanName = document.createElement("span");
       spanName.textContent = "DELPHOS";
       spanName.style.fontSize = "1.875rem";
       spanName.style.fontWeight = "300";
       spanName.style.letterSpacing = "0.05em";
       const spanAI = document.createElement("span");
       spanAI.textContent = "AI";
       spanAI.style.fontSize = "1.5rem";
       spanAI.style.fontWeight = "600";
       spanAI.style.backgroundColor = "black";
       spanAI.style.color = "white";
       spanAI.style.width = "2.25rem";
       spanAI.style.height = "2.25rem";
       spanAI.style.borderRadius = "9999px";
       spanAI.style.display = "flex";
       spanAI.style.alignItems = "center";
       spanAI.style.justifyContent = "center";
       spanAI.style.fontFamily = "'Montserrat', sans-serif";
       titleDiv.appendChild(spanName);
       titleDiv.appendChild(spanAI);
       headerContent.appendChild(titleDiv);
      } else {
       headerContent.classList.remove("delphos");
       headerContent.classList.add("athena");
       headerContent.innerHTML = `
        <img
         alt="Black outline drawing of a Spartan helmet facing right with a crest on top"
         aria-hidden="true"
         class="w-24 sm:w-36 h-24 sm:h-36"
         decoding="async"
         draggable="false"
         loading="lazy"
         src="https://storage.googleapis.com/a1aa/image/83399b9e-f54e-4715-2e1c-b5724400b7a8.jpg"
         id="header-image"
        />
        <div class="flex items-center space-x-2" id="header-text">
         <span class="text-3xl sm:text-4xl font-thin tracking-wide select-text" id="header-name">
          ATHENA
         </span>
         <span
          class="text-white text-xl sm:text-2xl font-semibold w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center bg-black select-text"
          id="header-ai"
          style="font-family: 'Montserrat', sans-serif;"
         >
          AI
         </span>
        </div>
       `;
      }
      setTimeout(() => {
       headerContent.style.opacity = "1";
       headerContent.style.transform = "scale(1)";
       resolve();
      }, 50);
     }, 300);
    });
   }

   async function toggleMode() {
    if (currentMode === "athena") {
     currentMode = "delphos";
     modeToggle.textContent = "Modo: Delphos";
     modeToggle.setAttribute("aria-pressed", "true");
     chatContainer.classList.remove("mode-athena");
     chatContainer.classList.add("mode-delphos");
     chatHeader.textContent = "Chat Delphos AI";

     await animateHeaderChange("delphos");

     const systemMsg = createMessageElement(
      "Você está agora no modo Delphos AI: simulação jurídica preditiva baseada em decisões futuras.",
      "delphos",
      true
     );
     chatMessages.appendChild(systemMsg);
     scrollToBottom();
     updateRiskSimulatorVisibility(false);
     toggleRiskPanel(false);
    } else {
     currentMode = "athena";
     modeToggle.textContent = "Modo: Athena";
     modeToggle.setAttribute("aria-pressed", "false");
     chatContainer.classList.remove("mode-delphos");
     chatContainer.classList.add("mode-athena");
     chatHeader.textContent = "Chat Athena AI";

     await animateHeaderChange("athena");

     const systemMsg = createMessageElement(
      "Você voltou para Athena AI: assistência jurídica em tempo real.",
      "athena",
      true
     );
     chatMessages.appendChild(systemMsg);
     scrollToBottom();
     updateRiskSimulatorVisibility(false);
     toggleRiskPanel(false);
    }
   }

   fileUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const fileName = file.name;
    const userMsg = createMessageElement(`Enviei o documento: ${fileName}`, "user");
    chatMessages.appendChild(userMsg);
    scrollToBottom();
    setTimeout(() => {
     const analysisMsg = createMessageElement(
      `Análise do documento "${fileName}": Identifiquei possíveis cláusulas abusivas e riscos ocultos. Recomendo revisão detalhada.`,
      currentMode,
      false
     );
     chatMessages.appendChild(analysisMsg);
     scrollToBottom();
     conversationHistory.push({ role: "user", content: `Documento enviado: ${fileName}` });
     conversationHistory.push({ role: "ai", content: analysisMsg.textContent, mode: currentMode });
     updateDiagnosticPanel();
    }, 1500);
    e.target.value = "";
    toggleUploadPanel(false);
   });

   historyBtn.addEventListener("click", () => {
    historyContent.innerHTML = "";
    if (conversationHistory.length === 0) {
     historyContent.textContent = "Nenhuma conversa salva ainda.";
    } else {
     const grouped = conversationHistory.reduce((acc, msg) => {
      const key = msg.mode || "Geral";
      if (!acc[key]) acc[key] = [];
      acc[key].push(msg);
      return acc;
     }, {});
     for (const [mode, msgs] of Object.entries(grouped)) {
      const section = document.createElement("section");
      const h4 = document.createElement("h4");
      h4.textContent = mode.toUpperCase();
      h4.className = "font-semibold mb-2";
      section.appendChild(h4);
      msgs.forEach((m) => {
       const p = document.createElement("p");
       p.textContent = (m.role === "user" ? "Você: " : "IA: ") + m.content;
       p.className = m.role === "user" ? "text-gray-700" : "text-gray-900 italic";
       section.appendChild(p);
      });
      historyContent.appendChild(section);
     }
    }
    historyModal.classList.remove("hidden");
   });
   historyCloseBtn.addEventListener("click", () => {
    historyModal.classList.add("hidden");
   });
   historyModal.addEventListener("click", (e) => {
    if (e.target === historyModal) historyModal.classList.add("hidden");
   });

   riskSubmit.addEventListener("click", () => {
    const input = riskInput.value.trim();
    if (!input) {
     riskResult.textContent = "Por favor, descreva uma situação para análise.";
     return;
    }
    const score = Math.min(100, Math.floor(Math.random() * 100) + 1);
    riskResult.textContent = `Score de risco legal estimado: ${score}%.`;
   });

   function updateDiagnosticPanel() {
    diagnosticPanel.classList.remove("hidden");
    const risks = [];
    const actions = [];
    const checklist = [];

    const text = conversationHistory.map((m) => m.content.toLowerCase()).join(" ");

    if (text.includes("contrato")) risks.push("Contratos");
    if (text.includes("trabalho") || text.includes("trabalhista")) risks.push("Trabalhista");
    if (text.includes("cláusula abusiva")) actions.push("Revisar cláusulas contratuais");
    if (text.includes("documento") || text.includes("contrato")) checklist.push("Atualizar documentos legais");

    diagnosticList.innerHTML = "";
    if (risks.length === 0) risks.push("Nenhum risco detectado");
    if (actions.length === 0) actions.push("Nenhuma ação recomendada");
    if (checklist.length === 0) checklist.push("Nenhum item pendente");

    const createListItem = (iconClass, text) => {
     const li = document.createElement("li");
     li.innerHTML = `<i class="fas ${iconClass}"></i> ${text}`;
     return li;
    };

    diagnosticList.appendChild(createListItem("fa-exclamation-triangle", "Áreas com maior risco: " + risks.join(", ")));
    diagnosticList.appendChild(createListItem("fa-check-circle", "Ações recomendadas: " + actions.join(", ")));
    diagnosticList.appendChild(createListItem("fa-list-check", "Checklist: " + checklist.join(", ")));
   }

   function updateRiskSimulatorVisibility(show) {
    if (show) {
     riskToggleBtn.style.display = "flex";
    } else {
     riskToggleBtn.style.display = "none";
     toggleRiskPanel(false);
    }
   }

   function toggleRiskPanel(show) {
    if (show === undefined) {
     show = riskSimulator.style.display !== "flex";
    }
    if (show) {
     riskSimulator.style.display = "flex";
     riskToggleBtn.classList.add("active");
     riskToggleBtn.setAttribute("aria-expanded", "true");
    } else {
     riskSimulator.style.display = "none";
     riskToggleBtn.classList.remove("active");
     riskToggleBtn.setAttribute("aria-expanded", "false");
     riskResult.textContent = "";
     riskInput.value = "";
    }
   }

   function sendMessage() {
    const question = userInput.value.trim();
    if (!question) return;

    const userMessage = createMessageElement(question, "user");
    chatMessages.appendChild(userMessage);
    conversationHistory.push({ role: "user", content: question });
    scrollToBottom();

    userInput.value = "";
    autoResizeTextarea();

    const thinkingMessage = createMessageElement("Pensando...", currentMode, true);
    chatMessages.appendChild(thinkingMessage);
    scrollToBottom();

    setTimeout(() => {
     chatMessages.removeChild(thinkingMessage);
     let answer = "";
     if (currentMode === "athena") {
      answer = getAthenaResponse(question);
     } else {
      answer = getDelphosResponse(question);
     }
     const aiMessage = createMessageElement(answer, currentMode);
     chatMessages.appendChild(aiMessage);
     conversationHistory.push({ role: "ai", content: answer, mode: currentMode });
     scrollToBottom();
     updateDiagnosticPanel();
     if (currentMode === "delphos") {
      updateRiskSimulatorVisibility(true);
     } else {
      updateRiskSimulatorVisibility(false);
     }
    }, 1200);
   }

   uploadToggleBtn.addEventListener("click", () => {
    toggleUploadPanel();
   });

   riskToggleBtn.addEventListener("click", () => {
    toggleRiskPanel();
   });

   function toggleUploadPanel(show) {
    if (show === undefined) {
     show = uploadPanel.style.display !== "flex";
    }
    if (show) {
     uploadPanel.style.display = "flex";
     uploadToggleBtn.classList.add("active");
     uploadToggleBtn.setAttribute("aria-expanded", "true");
    } else {
     uploadPanel.style.display = "none";
     uploadToggleBtn.classList.remove("active");
     uploadToggleBtn.setAttribute("aria-expanded", "false");
    }
   }

   userInput.addEventListener("input", autoResizeTextarea);
   chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    sendMessage();
   });
   userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
     e.preventDefault();
     sendMessage();
    }
   });
   chatMessages.addEventListener("scroll", checkScrollPosition);
   scrollBtn.addEventListener("click", () => {
    scrollToBottom();
    scrollBtn.classList.remove("visible");
    userInput.focus();
   });
   chatMessages.addEventListener("DOMNodeInserted", () => {
    scrollToBottom();
    checkScrollPosition();
    chatMessages.focus();
   });
   modeToggle.addEventListener("click", async () => {
    await toggleMode();
    toggleUploadPanel(false);
    toggleRiskPanel(false);
   });

   autoResizeTextarea();
   checkScrollPosition();
  </script>
 </body>
</html>